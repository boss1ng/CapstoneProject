<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSee - Web Admin Panel</title>

    <!-- CSS -->
    <link rel="stylesheet" href="styles/places.css">

    <!-- BOOTSTRAP v5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

    <!-- BOOTSTRAP v5.0 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- AXIOS -->
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-storage.js"></script>

    <!-- BOOTSTRAP ICONS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">

</head>
<body style="background-color: #2F414F;">
    <div class="sidebar">
        <div class="d-flex align-items-center justify-content-center m-3 mt-5">
            <!-- <img src="images/Qsee.png"> -->
            <img src="images/zzz.png" style="width: 60%;">
        </div>

        <div class="aCont container d-flex align-items-center mt-5" id="landingCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="black" class="bi bi-person-circle" id="landingCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
            </svg>
            <a href="landing.html" class="mx-4">Account</a>
        </div>

        <div class="aCont container d-flex align-items-center mt-3" id="categoriesCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="black" class="bi bi-grid" id="categoriesCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
            </svg>
            <a href="categories.html" class="mx-4">Categories</a>
        </div>

        <div class="aSelectedCont container d-flex align-items-center mt-3" id="placeCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="white" class="bi bi-map" id="placeCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15.817.113A.5.5 0 0 1 16 .5v14a.5.5 0 0 1-.402.49l-5 1a.502.502 0 0 1-.196 0L5.5 15.01l-4.902.98A.5.5 0 0 1 0 15.5v-14a.5.5 0 0 1 .402-.49l5-1a.5.5 0 0 1 .196 0L10.5.99l4.902-.98a.5.5 0 0 1 .415.103zM10 1.91l-4-.8v12.98l4 .8V1.91zm1 12.98 4-.8V1.11l-4 .8v12.98zm-6-.8V1.11l-4 .8v12.98l4-.8z"/>
            </svg>
            <a href="places.html" class="mx-4">Establishments</a>
        </div>

        <div class="aCont container d-flex align-items-center mt-3" id="signoutCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="black" class="bi bi-box-arrow-left" id="signoutCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"/>
                <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
            </svg>
            <a id="signoutHref" class="mx-4">Sign Out</a>
        </div>
    </div>
      
    <div class="container" id="categoryPlacesCont">
        <div class="textCont container">

            <div class="container d-flex">
                <div class="container d-flex align-items-center justify-content-center">
                    <h1 class="mt-5">Edit Establishment</h1>
                </div>
            </div>
            
            <div class="inputCont container px-5 pt-3">
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Establishment Name</span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="estabName" onchange="updateInput()" aria-label="Username" aria-describedby="addon-wrapping"/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Category</span>
                    </div>
                    
                    <!--
                    <div class="form-group">
                        <label for="sel1">Default select list</label>
                        <select class="form-control" id="sel1">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                        </select>
                    </div>
                    -->

                    <div class="container btn-group">
                        <button type="button" class="btn btn-light" id="dropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="d-flex align-items-center">
                                <div class="container">
                                    <input type="text" placeholder="Select a Category" id="selectedCategory" style="border: none;" disabled>
                                </div>
                                <div class="container text-end">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill text-end" viewBox="0 0 16 16">
                                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="width: 97.5%;" id="categoryOptions" onchange="updateInput()" >
                            <!--                             
                            <li><button class="dropdown-item" type="button">Action</button></li>
                            <li><button class="dropdown-item" type="button">Another action</button></li>
                            <li><button class="dropdown-item" type="button">Something else here</button></li>
                            -->
                        </ul>
                    </div>
                    
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Address</span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="estabAddress" onchange="addLatLong()" aria-label="Username" aria-describedby="addon-wrapping"/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Contact No.</span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="estabContact" onchange="updateInput()" aria-label="Username" aria-describedby="addon-wrapping"/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Latitude</span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="geocodeLat" aria-label="Username" aria-describedby="addon-wrapping" disabled/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Longitude</span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="geocodeLong" aria-label="Username" aria-describedby="addon-wrapping" disabled/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Highest Price</span>
                        <span class="exclamation mx-2" title="Enter the estimated highest price in the establishment."><i class="bi bi-question-circle"></i></span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="estabHighPrice" onchange="updateInput()" aria-label="Username" aria-describedby="addon-wrapping"/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Lowest Price</span>
                        <span class="exclamation mx-2" title="Enter the estimated lowest price in the establishment."><i class="bi bi-question-circle"></i></span>
                    </div>
                    <div class="container">
                        <input type="text" class="form-control" id="estabLowPrice" onchange="updateInput()" aria-label="Username" aria-describedby="addon-wrapping"/>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Upload Image</span>
                    </div>
                    <div class="container d-flex align-items-center my-3">
                        <input type="text" class="form-control text-center fst-italic" id="inputLocImageEdit" aria-label="Username" aria-describedby="addon-wrapping" disabled style="width: 250px; font-size: medium;"/>
                        <!-- <button type="button" class="addBtn btn btn-secondary btn-lg mx-3" id="btnSignIn">Upload Image</button> -->
                        <input type="file" class="form-control mx-2" onchange="updateOtherInput(this)" id="inputLocImage" accept=".jpg, .jpeg, .png" aria-label="Username" aria-describedby="addon-wrapping" style="width: 108px; height: 40px; padding-top: 7px;"/>

                        <div class="col-auto px-3">
                            <span id="passwordHelpInline" style="font-size: medium; font-style: italic;">
                                File Types (.JPG .JPEG .PNG)
                            </span>
                            
                            <span id="passwordHelpInline" class="px-3" style="font-size: medium; font-style: italic;">
                                Image Resolution (600 x 400)
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="container d-flex align-items-center my-3">
                    <div class="headerCont">
                        <span class="">Establishment Description</span>
                    </div>
                    <div class="container">
                        <textarea class="form-control" id="estabDesc" onchange="updateInput()" rows="9"></textarea>
                    </div>
                </div>
            </div>

            <div class="container mt-5">
                <div class="d-flex align-items-center justify-content-center">
                    <button type="button" class="btn btn-danger btn-lg mx-5" id="actionCancelPlace">Cancel</button>
                    <button type="button" class="btn btn-success btn-lg mx-5" id="actionSavePlace" disabled>Save</button>
                </div>
            </div>

            <!-- <img src="" id="imageDatabase" style="width: 250px; height: 250px;"> -->

        </div>
    </div>

    <!-- ALERT MESSAGE (SUCCESS) -->
    <div class="alertCont">
        <div class="alert alert-success d-flex align-items-center" role="alert" id="editSuccess">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-check-circle-fill mx-3" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
                Establishment Successfuly Updated.
        </div>
    </div>

    <!-- ALERT MESSAGE (FAILED) -->
    <div class="alertCont">
        <div class="alert alert-danger d-flex align-items-center" role="alert" id="editFailed">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-exclamation-triangle-fill mx-3" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
                Edit of Establishment Failed. Please try again.
        </div>
    </div>

    <!-- ALERT MESSAGE (SUCCESS) -->
    <div class="alertCont">
        <div class="alert alert-success d-flex align-items-center" role="alert" id="logout">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-check-circle-fill mx-3" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
                Logout successful. You have been logged out of your account.
        </div>
    </div>

    <!-- ALERT MESSAGE (Image Resolution) -->
    <div class="alertCont">
        <div class="alert alert-warning d-flex align-items-center" role="alert" id="imageResolution">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-exclamation-triangle-fill mx-3" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
                Kindly comply with the image resolution.
        </div>
    </div>

    <script>

        if (localStorage.getItem('loggedUser') == "" || localStorage.getItem('loggedUser') == null) {
            window.location.replace("index.html");
        }

        var buttonSave = document.querySelector("#actionSavePlace");

        function updateOtherInput(inputFile) {
            var inputLocImageEdit = document.querySelector("#inputLocImageEdit");
            var imageResolutionAlert = document.getElementById("imageResolution");

            var inputLocation = document.querySelector("#estabName");
            var inputLocationAdd = document.querySelector("#estabAddress");
            var inputLocationCat = document.querySelector("#selectedCategory");
            var inputLocationCatDropdown = document.querySelector("#dropdownBtn");
            var inputLocationCont = document.querySelector("#estabContact");
            var inputLocationLat = document.querySelector("#geocodeLat");
            var inputLocationLong = document.querySelector("#geocodeLong");
            var inputLocationHigh = document.querySelector("#estabHighPrice");
            var inputLocationLow = document.querySelector("#estabLowPrice");
            var inputLocationImage = document.querySelector("#inputLocImage");
            var inputLocationDesc = document.querySelector("#estabDesc");

            var buttonCancel = document.querySelector("#actionCancelPlace");
            var buttonSave = document.querySelector("#actionSavePlace");

            if (inputFile.files && inputFile.files[0]) {
                var img = new Image();
                img.src = URL.createObjectURL(inputFile.files[0]);
                img.onload = function() {
                    var width = this.width;
                    var height = this.height;
                    if (width === 600 && height === 400) {
                        // Image resolution is acceptable
                        var selectedFile = inputFile.files[0];

                        // Check if a file was selected
                        if (selectedFile) 
                            // Update the value of the other input tag (display the file name)
                            inputLocImageEdit.value = selectedFile.name;

                        buttonSave.disabled = false;
                        
                    } else {

                        buttonCancel.disabled = true;

                        inputLocation.disabled = true;
                        inputLocationAdd.disabled = true;
                        inputLocationCat.disabled = true;
                        inputLocationCatDropdown.disabled = true;
                        inputLocationCont.disabled = true;
                        inputLocationImage.disabled = true;
                        inputLocImageEdit.disabled = true;
                        inputLocationDesc.disabled = true;
                        // alert("Please upload an image with the correct resolution.");

                        imageResolutionAlert.style.visibility = "visible";
                        setTimeout(function(){
                                imageResolutionAlert.style.visibility = "hidden";
                                inputFile.value = ""; // Clear the input field

                                buttonCancel.disabled = false;

                                inputLocation.disabled = false;
                                inputLocationAdd.disabled = false;
                                inputLocationCat.disabled = false;
                                inputLocationCatDropdown.disabled = false;
                                inputLocationCont.disabled = false;
                                inputLocationImage.disabled = false;
                                inputLocImageEdit.disabled = false;
                                inputLocationDesc.disabled = false;
                            }, 2000);
                    }
                };
            }

            /*
            var selectedFile = inputFile.files[0];

            // Check if a file was selected
            if (selectedFile) 
                // Update the value of the other input tag (display the file name)
                inputLocImageEdit.value = selectedFile.name;
            
            buttonSave.disabled = false;
            */
        }

        function changeSelected(categoryOption) {
            const selectedCat = document.getElementById('selectedCategory');
            var inputLocationHigh = document.querySelector("#estabHighPrice");
            var inputLocationLow = document.querySelector("#estabLowPrice");
            var inputLocationCont = document.querySelector("#estabContact");

            selectedCat.value = categoryOption;

            if (selectedCat.value == "Accommodations" || selectedCat.value == "Restaurants and Cafes") {
                inputLocationHigh.disabled = false;
                inputLocationHigh.value = "";
                inputLocationLow.disabled = false;
                inputLocationLow.value = "";
            }

            else {
                inputLocationHigh.disabled = true;
                inputLocationHigh.value = "";
                inputLocationLow.disabled = true;
                inputLocationLow.value = "";
            }

            buttonSave.disabled = false;
        }

        function updateInput() {
            buttonSave.disabled = false;
        }

    </script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyB08GrYWprzzbddoHqvTR5Ln-9i0CEXqHs",
            authDomain: "capstone-project-ffe21.firebaseapp.com",
            databaseURL: "https://capstone-project-ffe21-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "capstone-project-ffe21",
            storageBucket: "capstone-project-ffe21.appspot.com",
            messagingSenderId: "67612839105",
            appId: "1:67612839105:web:7d8ffd05e13733ef609840",
            measurementId: "G-2BJMTCZ2SM"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        import {getDatabase, set, get, update, remove, ref, child, limitToLast, push }
        from "https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js"
        
        const db = getDatabase();

        const locationToEdit = sessionStorage.getItem('locationID_PK');

        var inputLocation = document.querySelector("#estabName");
        var inputLocationAdd = document.querySelector("#estabAddress");
        var inputLocationCat = document.querySelector("#selectedCategory");
        var inputLocationCont = document.querySelector("#estabContact");
        var inputLocationLat = document.querySelector("#geocodeLat");
        var inputLocationLong = document.querySelector("#geocodeLong");
        var inputLocationHigh = document.querySelector("#estabHighPrice");
        var inputLocationLow = document.querySelector("#estabLowPrice");
        var inputLocationImage = document.querySelector("#inputLocImage");
        var inputLocationDesc = document.querySelector("#estabDesc");

        var inputLocImageEdit = document.querySelector("#inputLocImageEdit");

        var editSuccessAlert = document.getElementById("editSuccess");
        var editFailedAlert = document.getElementById("editFailed");
        var logoutAlert = document.getElementById("logout");

        const categoryIcon = document.getElementById('imageDatabase');
        var firebaseImage = null;
        var isRSS = false;

        fetchAndPopulateCategory();
        fetchAndPopulate();

        // Fetch data from the database and populate the table
        function fetchAndPopulate() {
            const dbref = ref(db)

            get(child(dbref, "Location/" + locationToEdit))
            .then( (snapshot)=> {
                if(snapshot.exists()) {
                    inputLocation.value = snapshot.val().Location;
                    inputLocationCat.value = snapshot.val().Category;

                    if (inputLocationCat.value == "Religious Sites" || inputLocationCat.value == "Schools") {
                        inputLocationHigh.disabled = true;
                        inputLocationLow.disabled = true;
                    }

                    inputLocationAdd.value = snapshot.val().Address;
                    inputLocationCont.value = snapshot.val().ContactNo;
                    inputLocationLat.value = snapshot.val().Latitude;
                    inputLocationLong.value = snapshot.val().Longitude;
                    inputLocationDesc.value = snapshot.val().Description;
                    inputLocationLow.value = snapshot.val().LowestPrice;
                    inputLocationHigh.value = snapshot.val().HighestPrice;
                    inputLocImageEdit.value = snapshot.val().Image;

                    createdBy = snapshot.val().CreatedBy;
                    if (createdBy == "RSS") {
                        isRSS = true;
                    }

                    firebaseImage = snapshot.val().Image;

                    categoryIcon.src = snapshot.val().Link;
                }
            })
        }

        // Fetch data from the database and populate the table
        function fetchAndPopulateCategory() {
            const dbref = ref(db)

            get(child(dbref, "Category"))
            .then( (snapshot)=> {
                if(snapshot.exists()) {
                    
                    const categoriesData = [];
                    snapshot.forEach(childSnapshot => {
                        const category = {
                            Key: childSnapshot.key,
                            Category: childSnapshot.val().Category,
                            Icon: childSnapshot.val().Icon
                        };
                        categoriesData.push(category);
                    });

                    populateTable(categoriesData);
                }
            })
        }

        // Populate the table with the fetched data
        function populateTable(data) {

            // Reference to the <ul> element
            const listElement = document.getElementById('categoryOptions');

            data.forEach(category => {
                const list = document.createElement('li');
                list.innerHTML = `
                    <button class="dropdown-item" type="button" onclick="changeSelected('${category.Category}')">${category.Category}</button>
                `;

                // Append the list item to the <ul>
                listElement.appendChild(list);
            });
        }

        function editLocation() {

            buttonSave.disabled = true;
            buttonCancel.disabled = true;

            inputLocation.disabled = true;
            inputLocationAdd.disabled = true;
            inputLocationCat.disabled = true;
            inputLocationCont.disabled = true;
            inputLocationHigh.disabled = true;
            inputLocationLow.disabled = true;
            inputLocationImage.disabled = true;
            inputLocImageEdit.disabled = true;
            inputLocationDesc.disabled = true;

            if (inputLocationImage.value == "" || inputLocationImage.value == null) {
                // UPDATE Location Information (except Image) in Firebase Realtime Database
                update(ref(db, 'Location/' + locationToEdit), {
                    Location: inputLocation.value,                      // 
                    Category: inputLocationCat.value,
                    Address: inputLocationAdd.value,                    // 
                    ContactNo: inputLocationCont.value,                 // 
                    Latitude: inputLocationLat.value,
                    Longitude: inputLocationLong.value,
                    Description: inputLocationDesc.value,               // 
                    LowestPrice: inputLocationLow.value,                // 
                    HighestPrice: inputLocationHigh.value,              // 
                })

                .then( ()=>{
                    // alert('URL updated to firebase realtimedatabase');
                    editSuccessAlert.style.visibility = "visible";
                    setTimeout(function() {
                        sessionStorage.clear();
                        window.location.replace("places.html");
                    }, 2000);
                })

                .catch( (error)=> {
                    alert(error);
                })
            }

            else {

                if (isRSS) {

                }

                else {
                    
                }

                var uploadedFile = inputLocationImage.files[0]; // Get the selected file
                var fileInputName = uploadedFile.name;

                // Initialize Cloud Storage
                const storage = firebase.storage();
                const storageRef = storage.ref();

                // Reference the specific file you want to delete
                const fileRef = storageRef.child('Location/' + firebaseImage);

                // Delete the file
                fileRef.delete()
                .then(() => {
                    // File has been successfully deleted
                    console.log('File deleted successfully.');
                })
                .catch((error) => {
                    // Handle any errors that occur during deletion
                    console.error('Error deleting file:', error);
                });

                // Upload NEW FILE
                const uploadTask = storageRef.child('Location/' + fileInputName).put(uploadedFile);

                // Listen for upload completion
                uploadTask.on('state_changed', (snapshot) => {
                    // Track the progress of the upload here if needed

                }, (error) => {
                    // Handle any errors that occur during the upload

                }, () => {
                    // The upload is complete, and the file is now in Firebase Storage

                    // Get the download URL of the uploaded file
                    storageRef.child('Location/' + fileInputName).getDownloadURL()
                        .then((url) => {
                            // Use the URL to access or display the uploaded file
                            console.log('Download URL:', url);

                            // UPDATE URL to the Existing Record in Firebase Realtime Database
                            update(ref(db, 'Location/' + locationToEdit), {
                                Location: inputLocation.value,                      // 
                                Category: inputLocationCat.value,
                                Address: inputLocationAdd.value,                    // 
                                ContactNo: inputLocationCont.value,                 // 
                                Latitude: inputLocationLat.value,
                                Longitude: inputLocationLong.value,
                                Description: inputLocationDesc.value,               // 
                                LowestPrice: inputLocationLow.value,                // 
                                HighestPrice: inputLocationHigh.value,              // 
                                Image: fileInputName,                               // 
                                Link: url,
                            })

                            .then( ()=>{
                                // alert('URL updated to firebase realtimedatabase');
                                editSuccessAlert.style.visibility = "visible";
                                setTimeout(function() {
                                    sessionStorage.clear();
                                    window.location.replace("places.html");
                                }, 2000);
                            })

                            .catch( (error)=> {
                                alert(error);
                            })

                        })

                        .catch((error) => {
                            // Handle any errors that occur while retrieving the download URL
                        });
                });

            }
        }
        
        var buttonSave = document.querySelector("#actionSavePlace");
        buttonSave.addEventListener('click', editLocation)

        // ---------------------------------------------------------------------------------

        

        // ---------------------------------------------------------------------------------

        var buttonCancel = document.querySelector("#actionCancelPlace");
        buttonCancel.addEventListener('click', goNext)

        function goNext() {
            window.location.replace("places.html")
        }
        
        // ---------------------------------------------------------------------------------

        var buttonLanding = document.querySelector("#landingCont");
        buttonLanding.addEventListener('click', goNext1)

        function goNext1() {
            window.location.replace("landing.html")
        }

        var buttonCategory = document.querySelector("#categoriesCont");
        buttonCategory.addEventListener('click', goNext2)

        function goNext2() {
            window.location.replace("categories.html")
        }

        var buttonPlaces = document.querySelector("#placeCont");
        buttonPlaces.addEventListener('click', goNext3)

        function goNext3() {
            window.location.replace("places.html")
        }

        var buttonSignOut = document.querySelector("#signoutCont");
        buttonSignOut.addEventListener('click', goNext4)
        var buttonSignOutHref = document.querySelector("#signoutHref");
        buttonSignOutHref.addEventListener('click', goNext4);

        function goNext4() {

            logoutAlert.style.visibility = "visible";
            setTimeout(function() {
                window.location.replace("index.html");
            }, 2000);
        }

    </script>

    <script>

        function addLatLong() {

            var inputLocationAdd = document.querySelector("#estabAddress").value;
            var estabLat = document.getElementById('geocodeLat');
            var estabLong = document.getElementById('geocodeLong');

            axios.get('https://maps.googleapis.com/maps/api/geocode/json', {
                params: {
                    address: inputLocationAdd,
                    key: 'AIzaSyAwTBhjMDtD74Nvqz7eUbN81v93SLhM3IU'
                }
            })
            .then(function(response) {
                console.log(response);

                // Geometry
                var lat = response.data.results[0].geometry.location.lat;
                var long = response.data.results[0].geometry.location.lng;

                // Output to app
                estabLat.value = lat;
                estabLong.value = long;
            }) 
            .catch(function(error) {
                console.log(error);
            })

            buttonSave.disabled = false;
        }

    </script>

    <!-- BOOTSTRAP v5.3 -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>

</body>
</html>