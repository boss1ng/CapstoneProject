<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSee - Web Admin Panel</title>

    <!-- CSS -->
    <link rel="stylesheet" href="styles/places.css">

    <!-- BOOTSTRAP v5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

    <!-- BOOTSTRAP v5.0 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

</head>
<body>
    <div class="sidebar">
        <div class="d-flex align-items-center justify-content-center m-3 mt-5">
            <img src="images/Qsee.png">
        </div>

        <div class="aCont container d-flex align-items-center mt-5" id="landingCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="black" class="bi bi-person-circle" id="landingCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
            </svg>
            <a href="landing.html" class="mx-4">Account</a>
        </div>

        <div class="aCont container d-flex align-items-center mt-3" id="categoriesCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="black" class="bi bi-grid" id="categoriesCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
            </svg>
            <a href="categories.html" class="mx-4">Categories</a>
        </div>

        <div class="aSelectedCont container d-flex align-items-center mt-3" id="placeCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="white" class="bi bi-map" id="placeCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15.817.113A.5.5 0 0 1 16 .5v14a.5.5 0 0 1-.402.49l-5 1a.502.502 0 0 1-.196 0L5.5 15.01l-4.902.98A.5.5 0 0 1 0 15.5v-14a.5.5 0 0 1 .402-.49l5-1a.5.5 0 0 1 .196 0L10.5.99l4.902-.98a.5.5 0 0 1 .415.103zM10 1.91l-4-.8v12.98l4 .8V1.91zm1 12.98 4-.8V1.11l-4 .8v12.98zm-6-.8V1.11l-4 .8v12.98l4-.8z"/>
            </svg>
            <a href="places.html" class="mx-4">Places</a>
        </div>

        <div class="aCont container d-flex align-items-center mt-3" id="signoutCont">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="black" class="bi bi-box-arrow-left" id="signoutCont" style="margin-left: 40px;" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"/>
                <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
            </svg>
            <a id="signoutHref" class="mx-4">Sign Out</a>
        </div>
    </div>
      
    <div class="container" id="categoryPlacesCont">
        <div class="textCont container">

            <div class="container d-flex my-3">
                <div class="container d-flex align-items-center mt-4">
                    <h1 class="">Places</h1>
                </div>

                <div class="container d-flex align-items-center justify-content-end mt-4">
                    <form class="nosubmit">
                        <input class="form-control" type="search" id="searchInput" autocomplete="off" onchange="searchLocation(this)">
                    </form>

                    <div class="btn-group mx-4">
                        <button type="button" class="btn" id="dropdownCategory" data-bs-toggle="dropdown" aria-expanded="false">
                            <img class="filterImg" src="images/Filter.png"/>                            
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="width:auto" id="categoryOptionsFilter">
                            <li><button class="dropdown-item" type="button" onclick="filterLocBasedSelectedCategory()">-</button></li>

                            <!-- REGISTERED CATEGORIES -->
                        </ul>
                    </div>
                    
                    <svg xmlns="http://www.w3.org/2000/svg" id="addPlace" width="40" height="40" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                    </svg>
                </div>
            </div>

            <div class="container">
                <div class="container">

                    <table class="categoryTable table-hover table-bordered table-transparent" id="categoryTable">
                        <thead>
                            <tr>
                                <th>Establishment</th>
                                <th>Category</th>
                                <th>Action</th>
                            </tr>
                        </thead>

                        <tbody></tbody>
                    </table>

                </div>
            </div>

        </div>
    </div>

    <!-- MODAL - Confirmation Box -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Confirm Delete?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This will be deleted permanently. Are you sure you want to delete this location? 
                </div>
                <div class="modal-footer">
                    <button type="button" class="modalBtn btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="modalBtn btn btn-danger" id="confirmDelete" data-bs-dismiss="modal" onclick="deleteLocationConfirmed()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ALERT MESSAGE (SUCCESS) -->
    <div class="alertCont">
        <div class="alert alert-success d-flex align-items-center" role="alert" id="deleteSuccess">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-check-circle-fill mx-3" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
                Establishment Successfuly Deleted.
        </div>
    </div>

    <!-- ALERT MESSAGE (SUCCESS) -->
    <div class="alertCont">
        <div class="alert alert-success d-flex align-items-center" role="alert" id="logout">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-check-circle-fill mx-3" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
                Logout successful. You have been logged out of your account.
        </div>
    </div>

    <script>

        if (localStorage.getItem('loggedUser') == "" || localStorage.getItem('loggedUser') == null) {
            window.location.replace("index.html");
        }

        // sessionStorage.clear();
        document.getElementById('searchInput').value = sessionStorage.getItem('searchLoc');

        var deleteSuccessAlert = document.getElementById("deleteSuccess");
        var confirmDeleteBtn = document.getElementById("confirmDelete");

        function deleteLocation(locationID) {
            // alert(locationID);
            confirmDeleteBtn.value = locationID;
        }

        function deleteLocationConfirmed() {
            const locationID = confirmDeleteBtn.value;

            deleteSuccessAlert.style.visibility = "visible";
            setTimeout(function() {
                sessionStorage.setItem('locationID_ToDelete', locationID);
                window.location.href = "placesDelete.html";
            }, 2000);
        }

        function editLocation(locationID) {
            // alert(locationID);
            sessionStorage.setItem('locationID_PK', locationID);
            window.location.href = "placesEdit.html";
        }

        /*
        const form = document.getElementById('searchForm');
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevents the default form submission behavior
            const inputValue = form.querySelector('#searchInput').value;
            alert(`You entered: ${inputValue}`);
            // You can add your custom JavaScript logic here
        });
        */

        function searchLocation(input) {
            const searchInput = input.value.toLowerCase();
            sessionStorage.setItem('searchLoc', searchInput);
            // alert(searchInput)
        }

        function filterLocBasedSelectedCat(category) {
            // alert(category);
            sessionStorage.setItem('selectedCategory', category);
            location.reload();
        }

        function filterLocBasedSelectedCategory() {
            // alert("- None -");
            sessionStorage.removeItem("selectedCategory");
            location.reload();
        }


    </script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyB08GrYWprzzbddoHqvTR5Ln-9i0CEXqHs",
            authDomain: "capstone-project-ffe21.firebaseapp.com",
            databaseURL: "https://capstone-project-ffe21-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "capstone-project-ffe21",
            storageBucket: "capstone-project-ffe21.appspot.com",
            messagingSenderId: "67612839105",
            appId: "1:67612839105:web:7d8ffd05e13733ef609840",
            measurementId: "G-2BJMTCZ2SM"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        import {getDatabase, set, get, update, remove, ref, child, limitToLast, push }
        from "https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js"
        
        const db = getDatabase();

        const inputSearchLoc = sessionStorage.getItem('searchLoc');
        const filterLocations = sessionStorage.getItem('selectedCategory');
        const filterLocationsBasedOnCategoryPage = sessionStorage.getItem('filterCategory');

        var logoutAlert = document.getElementById("logout");
        
        fetchAndPopulate();

        // Fetch data from the database and populate the table
        /*
        function fetchAndPopulate() {
            const dbref = ref(db)

            get(child(dbref, "Location"))
            .then( (snapshot)=> {
                if(snapshot.exists()) {
                    
                    const locationsData = [];
                    snapshot.forEach(childSnapshot => {
                        const location = {
                            Key: childSnapshot.key,
                            Location: childSnapshot.val().Location,
                            Category: childSnapshot.val().Category,
                            Address: childSnapshot.val().Address,
                            ContactNo: childSnapshot.val().ContactNo,
                            Latitude: childSnapshot.val().Latitude,
                            Longitude: childSnapshot.val().Longitude,
                            Description: childSnapshot.val().Description,
                            LowestPrice: childSnapshot.val().LowestPrice,
                            HighestPrice: childSnapshot.val().HighestPrice,
                            Image: childSnapshot.val().Image,
                            ImageDescription: childSnapshot.val().ImageDescription
                        };
                        locationsData.push(location);
                    });

                    populateTable(locationsData);
                }
            })
        }*/

        function fetchAndPopulate() {
            const dbref = ref(db)

            get(child(dbref, "Location"))
            .then( (snapshot)=> {
                if(snapshot.exists()) {
                    
                    const locationsData = [];
                    snapshot.forEach(childSnapshot => {
                        const location = {
                            Key: childSnapshot.key,
                            Location: childSnapshot.val().Location,
                            Category: childSnapshot.val().Category,
                            Address: childSnapshot.val().Address,
                            ContactNo: childSnapshot.val().ContactNo,
                            Latitude: childSnapshot.val().Latitude,
                            Longitude: childSnapshot.val().Longitude,
                            Description: childSnapshot.val().Description,
                            LowestPrice: childSnapshot.val().LowestPrice,
                            HighestPrice: childSnapshot.val().HighestPrice,
                            Image: childSnapshot.val().Image,
                            ImageDescription: childSnapshot.val().ImageDescription
                        };
                        locationsData.push(location);
                    });

                    fetchAndPopulateCat(locationsData);
                }
            })
        }

        function fetchAndPopulateCat(locationData) {
            const dbref = ref(db)

            get(child(dbref, "Category"))
            .then( (snapshot)=> {
                if(snapshot.exists()) {
                    
                    const categoriesData = [];
                    snapshot.forEach(childSnapshot => {
                        const category = {
                            Key: childSnapshot.key,
                            Category: childSnapshot.val().Category,
                            Icon: childSnapshot.val().Icon
                        };
                        categoriesData.push(category);
                    });

                    populateTable(categoriesData, locationData);
                }
            })
        }

        // Populate the table with the fetched data                 filterLocationsBasedOnCategoryPage
        function populateTable(categoryData, locationData) {
            const tbody = document.querySelector('#categoryTable tbody');
            tbody.innerHTML = ''; // Clear existing rows

            locationData.forEach(location => {

                if (filterLocationsBasedOnCategoryPage != undefined) {
                    categoryData.forEach(category => {
        
                        if (filterLocationsBasedOnCategoryPage == category.Category) {

                            if (location.Category == category.Category) {

                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="">${location.Location}</td>
                                    <td class="">${location.Category}</td>
                                    
                                    <td class="actionCol">
                                        <button type="button" class="btn btn-info btn-md rounded-pill mx-3" id="btnEdit" onclick="editLocation('${location.Key}')">Edit</button>
                                        <button type="button" class="btn btn-danger btn-md rounded-pill mx-3" id="btnDelete" onclick="deleteLocation('${location.Key}')" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Delete</button>
                                    </td>
                                `;
                                tbody.appendChild(row);

                            }
                         
                            
                        }
                    });  
                }

                else {

                    if (location.Location.toLowerCase().includes(inputSearchLoc) || inputSearchLoc == undefined) {
                        if (filterLocations == "-" || filterLocations == undefined) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="">${location.Location}</td>
                                <td class="">${location.Category}</td>
                                <td class="actionCol">
                                    <button type="button" class="btn btn-info btn-md rounded-pill mx-3" id="btnEdit" onclick="editLocation('${location.Key}')">Edit</button>
                                    <button type="button" class="btn btn-danger btn-md rounded-pill mx-3" id="btnDelete" onclick="deleteLocation('${location.Key}')" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        }

                        else { // filterLocations != "-" || filterLocations != undefined || filterLocationsBasedOnCategoryPage != undefined
                            if (location.Category == filterLocations) {
                                categoryData.forEach(category => {
        
                                    if (location.Category == category.Category) {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td class="">${location.Location}</td>
                                            
                                            <td class="actionCol">
                                                <button type="button" class="btn btn-info btn-md rounded-pill mx-3" id="btnEdit" onclick="editLocation('${location.Key}')">Edit</button>
                                                <button type="button" class="btn btn-danger btn-md rounded-pill mx-3" id="btnDelete" onclick="deleteLocation('${location.Key}')" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Delete</button>
                                            </td>
                                        `;
                                        tbody.appendChild(row);
                                    }
                                });  
                            }               
                        }
                    }

                }

                

                /*
                if (location.Location.toLowerCase().includes(inputSearchLoc) || inputSearchLoc == undefined) {
                    // alert(inputSearchLoc)

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="">${location.Location}</td>
                        <td class="actionCol">
                            <button type="button" class="btn btn-info btn-md rounded-pill mx-3" id="btnEdit" onclick="editLocation('${location.Key}')">Edit</button>
                            <button type="button" class="btn btn-danger btn-md rounded-pill mx-3" id="btnDelete" onclick="deleteLocation('${location.Key}')" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
                */

                
            });
        }

        // ---------------------------------------------------------------------------------

        var buttonAdd = document.querySelector("#addPlace");
        buttonAdd.addEventListener('click', goNext)

        function goNext() {
            window.location.replace("placesAdd.html")
        }

        // ---------------------------------------------------------------------------------

        var buttonLanding = document.querySelector("#landingCont");
        buttonLanding.addEventListener('click', goNext1)

        function goNext1() {
            window.location.replace("landing.html")
        }

        var buttonCategory = document.querySelector("#categoriesCont");
        buttonCategory.addEventListener('click', goNext2)

        function goNext2() {
            window.location.replace("categories.html")
        }

        var buttonPlaces = document.querySelector("#placeCont");
        buttonPlaces.addEventListener('click', goNext3)

        function goNext3() {
            sessionStorage.clear();
            window.location.replace("places.html")
        }

        var buttonSignOut = document.querySelector("#signoutCont");
        buttonSignOut.addEventListener('click', goNext4)
        var buttonSignOutHref = document.querySelector("#signoutHref");
        buttonSignOutHref.addEventListener('click', goNext4);

        function goNext4() {

            logoutAlert.style.visibility = "visible";
            setTimeout(function() {
                window.location.replace("index.html");
            }, 2000);
        }

        // ---------------------------------------------------------------------------------

        fetchAndPopulateFilteringCategories();

        // Fetch data from the database and populate the table
        function fetchAndPopulateFilteringCategories() {
            const dbref = ref(db)

            get(child(dbref, "Category"))
            .then( (snapshot)=> {
                if(snapshot.exists()) {
                    
                    const categoriesData = [];
                    snapshot.forEach(childSnapshot => {
                        const category = {
                            Key: childSnapshot.key,
                            Category: childSnapshot.val().Category,
                            Icon: childSnapshot.val().Icon
                        };
                        categoriesData.push(category);
                    });

                    populateDropdown(categoriesData);
                }
            })
        }

        // Populate the table with the fetched data
        function populateDropdown(data) {

            // Reference to the <ul> element
            const listElement = document.getElementById('categoryOptionsFilter');

            data.forEach(category => {
                const list = document.createElement('li');
                list.innerHTML = `
                    <button class="dropdown-item" type="button" onclick="filterLocBasedSelectedCat('${category.Category}')">${category.Category}</button>
                `;

                // Append the list item to the <ul>
                listElement.appendChild(list);
            });
        }

    </script>

    <!-- BOOTSTRAP v5.3 -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>

</body>
</html>